<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AD 用户创建工具 - 职位管理</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root{--color-primary:#00897B;--color-bg-light:#F0F2F5;--color-sidebar-bg:white;--color-card-bg:white;--color-text-dark:#424242;--color-text-light:#616161;--color-input-bg:#F9F9F9;--color-border-light:#D1D5DB}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:var(--color-bg-light);margin:0;min-height:100vh}
        .sidebar{width:240px;background-color:var(--color-sidebar-bg);box-shadow:2px 0 10px rgba(0,0,0,.05);padding-top:20px;position: fixed; top: 0; left: 0; height: 100vh; overflow-y: auto;}
        .main-content{padding:30px;margin-left: 240px;}
        .sidebar-title{font-size:18px;font-weight:600;padding:0 20px 25px;color:var(--color-text-dark)}.nav-item{padding:12px 20px;font-size:15px;color:var(--color-text-dark);text-decoration:none;display:flex;align-items:center;transition:background-color .2s;margin:0 10px;border-radius:8px}.nav-item-active{background-color:var(--color-primary) !important;color:white !important;font-weight:600}.nav-item:hover:not(.nav-item-active){background-color:#F0F0F0}.nav-icon{margin-right:15px;width:18px}.header{background-color:var(--color-card-bg);border-radius:12px;padding:18px 25px;margin-bottom:30px;box-shadow:0 1px 5px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}.welcome-title{font-size:20px;font-weight:500;color:var(--color-text-dark);margin:0}.connection-info{font-size:14px;color:var(--color-primary)}.card{background-color:var(--color-card-bg);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:35px;margin-bottom:30px}.card-title{font-size:22px;font-weight:600;color:var(--color-text-dark);border-bottom:1px solid #E0E0E0;padding-bottom:15px;margin-bottom:25px}.form-group{margin-bottom:20px;display:flex;align-items:center}.form-group.align-top{align-items:flex-start;}
        .form-group.align-top label { padding-top: 10px; }
        .form-group label{width:180px;font-size:15px;color:var(--color-text-light);text-align:right;padding-right:20px;flex-shrink:0}.form-group input,.form-group select{flex-grow:1;padding:12px;border:1px solid var(--color-border-light);border-radius:8px;font-size:15px;background-color:var(--color-input-bg)}.btn{padding:10px 25px;color:white;border:none;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;transition:background-color .2s; text-decoration: none; display: inline-block;}.btn-create{background-color:var(--color-primary)}.btn-create:hover{background-color:#00695C}.btn-delete{background-color:#E53935}.btn-delete:hover{background-color:#C62828}.btn-edit{background-color:#546E7A; margin-right: 10px;}.btn-edit:hover{background-color:#37474F;}.btn-save{background-color:#43A047;}.btn-save:hover{background-color:#2E7D32;}.btn-cancel{background-color:#757575; margin-left:10px;}.btn-cancel:hover{background-color:#424242;}.set-item{display:flex;justify-content:space-between;align-items:center;padding:15px;border-bottom:1px solid #f0f0f0}.set-item:last-child{border-bottom:none}.set-name{font-weight:600;font-size:16px}.set-groups{list-style:none;padding-left:20px;color:#666;font-size:14px}.alert{padding:15px;border-radius:8px;margin-bottom:20px;font-weight:500;font-size:14px}.alert-success{background-color:#E6FFFA;color:#38A169;border:1px solid #A7F3D0}.alert-error{background-color:#FEE2E2;color:#DC2626;border:1px solid #FCA5A5}

        .checkbox-grid {
            /* --- 核心修改点：切换到 CSS Grid 布局 --- */
            display: grid;
            /* 自动填充列，每列最小220px，最大1fr (平分剩余空间) */
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            background-color: var(--color-input-bg);
            border: 1px solid var(--color-border-light);
            border-radius: 8px;
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .checkbox-item {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: start;
            gap: 5px;
            background-color: #fff;
            padding: 6px 10px 6px 8px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .checkbox-item:hover {
            border-color: var(--color-primary);
        }
        .checkbox-item input[type="checkbox"] {
            margin: 0;
            margin-top: 13px;
            cursor: pointer;
        }
        .checkbox-item label {
            font-size: 14px;
            color: var(--color-text-dark);
            cursor: pointer;
            white-space: normal;
            word-break: break-all;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-title">AD 管理面板</div>
        <a href="{{ url_for('main.dashboard') }}" class="nav-item"><i class="fas fa-user-plus nav-icon"></i>用户创建</a>
        <a href="{{ url_for('management.positions') }}" class="nav-item nav-item-active"><i class="fas fa-layer-group nav-icon"></i>职位管理</a>
        <a href="{{ url_for('management.rules') }}" class="nav-item"><i class="fas fa-scroll nav-icon"></i>规则管理</a>
        <a href="{{ url_for('management.settings') }}" class="nav-item"><i class="fas fa-cogs nav-icon"></i>服务器设置</a>
        <a href="{{ url_for('auth.logout') }}" class="nav-item"><i class="fas fa-sign-out-alt nav-icon"></i>退出登录</a>
    </div>
    <div class="main-content">
        <div class="header">
            <h2 class="welcome-title">职位管理</h2>
            <div class="connection-info">连接到: {{ config.DOMAIN_CONTROLLER_IP }} ({{ config.DOMAIN_NAME }})</div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %} <div class="alert alert-{{ category }}">{{ message }}</div> {% endfor %}
        {% endwith %}
        <div class="card">
            <div class="card-title">{{ '编辑职位' if edit_data else '创建新职位' }}</div>
            <form method="POST" action="{{ url_for('management.positions') }}">
                {% if edit_data %}
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="original_name" value="{{ edit_data.name }}">
                {% else %}
                    <input type="hidden" name="action" value="create">
                {% endif %}

                <div class="form-group">
                    <label for="position_name">职位名称:</label>
                    <input type="text" id="position_name" name="position_name" placeholder="例如：销售总监"
                           value="{{ edit_data.name if edit_data else '' }}" required>
                </div>
                <div class="form-group align-top">
                    <label>包含的用户组:</label>
                    <div class="checkbox-grid">
                        {% for group_dn in group_options %}
                            <div class="checkbox-item">
                                <input type="checkbox"
                                       name="groups"
                                       value="{{ group_dn }}"
                                       id="group_{{ loop.index }}"
                                       {% if edit_data and group_dn in edit_data.groups %}checked{% endif %}>
                                <label for="group_{{ loop.index }}">
                                    {{ group_dn.split(',')[0].replace('CN=', '') }}
                                </label>
                            </div>
                        {% else %}
                            <p>无法加载或暂无用户组。</p>
                        {% endfor %}
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    {% if edit_data %}
                        <button type="submit" class="btn btn-save">保 存 更 改</button>
                        <a href="{{ url_for('management.positions') }}" class="btn btn-cancel">取 消</a>
                    {% else %}
                        <button type="submit" class="btn btn-create">创 建 职 位</button>
                    {% endif %}
                </div>
            </form>
        </div>
        <div class="card">
            <div class="card-title">现有职位</div>
            {% if positions %}
                {% for position_name, groups_in_position in positions.items() %}
                <div class="set-item">
                    <div>
                        <div class="set-name">{{ position_name }}</div>
                        <ul class="set-groups">
                            {% for group_dn in groups_in_position %}<li>{{ group_dn.split(',')[0].replace('CN=', '') }}</li>{% endfor %}
                        </ul>
                    </div>
                    <div>
                        <a href="{{ url_for('management.positions', action='edit', name=position_name) }}" class="btn btn-edit">编辑</a>
                        <form method="POST" action="{{ url_for('management.positions') }}" style="display: inline;">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="position_name_to_delete" value="{{ position_name }}">
                            <button type="submit" class="btn btn-delete" onclick="return confirm('确定要删除这个职位吗？')">删除</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: #999;">暂无任何职位。</p>
            {% endif %}
        </div>
    </div>
</body>
</html>